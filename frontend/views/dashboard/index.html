<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href='https://unpkg.com/boxicons@2.0.9/css/boxicons.min.css' rel='stylesheet'>
	<link rel="stylesheet" href="../../assets/css/style.css">
	<link rel="stylesheet" href="../../assets/css/dashboard.css">
	<script src="../../src/services/ApiService.js"></script>
	<title>Sistema Campos Moto Peças - Dashboard</title>
</head>
<body>
	<section id="sidebar">
		<a href="../../index.html" class="brand"><img src="../../assets/images/logo.png" alt="Campos Moto Peças"></a>
		<ul class="side-menu">
			<li><a href="index.html" class="active"><i class='bx bxs-dashboard icon' ></i> Dashboard</a></li>
			<li class="divider" data-text="principal">Principal</li>
			<li><a href="../os/os-consulta.html"><i class='bx bxs-notepad icon' ></i> Ordem de Serviço</a></li>
			<li><a href="../orcamentos/orcamentos-consulta.html"><i class='bx bxs-calculator icon' ></i> Orçamentos</a></li>
			<li class="divider" data-text="gestão">Gestão</li>
			<li><a href="../clientes/clientes-consulta.html"><i class='bx bxs-user-detail icon' ></i> Clientes</a></li>
			<li><a href="../motos/motos-consulta.html"><i class='bx bx-car icon' ></i> Motocicletas</a></li>
			<li><a href="../marcas/marcas-consulta.html"><i class='bx bxs-tag-alt icon'></i> Marcas</a></li>
			<li><a href="../fornecedores/fornecedores-consulta.html"><i class='bx bxs-truck icon'></i> Fornecedores</a></li>
			<li><a href="../pecas/pecas-consulta.html"><i class='bx bxs-wrench icon'></i> Peças</a></li>
			<li><a href="../usuarios/usuarios-consulta.html"><i class='bx bxs-shield-alt-2 icon'></i> Usuários</a></li>
		</ul>
	</section>
	<section id="content">
		<nav>
			<i class='bx bx-menu toggle-sidebar' ></i>
			<div class="theme-toggle">
				<input type="checkbox" id="theme-toggle-checkbox">
				<label for="theme-toggle-checkbox" class="theme-toggle-label">
					<i class='bx bxs-sun'></i>
					<i class='bx bxs-moon'></i>
				</label>
			</div>
			<div class="profile">
				<a href="../../login.html" class="nav-link">
					<i class='bx bxs-log-out-circle icon' title="Sair"></i>
				</a>
			</div>
		</nav>
		<main>
			<h1 class="title">Dashboard</h1>
			<ul class="breadcrumbs">
				<li><a href="../../index.html">Home</a></li>
				<li class="divider">/</li>
				<li><a href="#" class="active">Dashboard</a></li>
			</ul>
			
			<!-- Botão de refresh e indicador de erro -->
			<div class="dashboard-controls" style="margin-bottom: 20px;">
				<button id="refresh-dashboard" class="btn btn-primary" style="margin-bottom: 10px;">
					<i class='bx bx-refresh'></i> Atualizar Dados
				</button>
				<div id="dashboard-error" class="alert alert-danger" style="display: none;"></div>
			</div>

			<!-- Cards de Estatísticas -->
			<div class="dashboard-stats">
				<div class="stats-grid">
					<div class="stat-card">
						<div class="stat-header">
							<div class="stat-content">
								<h2 id="servicos-mes" class="stat-number">-</h2>
								<p class="stat-label">Serviços no Mês</p>
							</div>
							<div class="stat-icon">
								<i class='bx bxs-calendar-check'></i>
							</div>
						</div>
						<div class="stat-footer">
							<span class="stat-trend" id="crescimento-mensal">-</span>
						</div>
					</div>
					
					<div class="stat-card">
						<div class="stat-header">
							<div class="stat-content">
								<h2 id="orcamentos-pendentes" class="stat-number">-</h2>
								<p class="stat-label">Orçamentos Pendentes</p>
							</div>
							<div class="stat-icon warning">
								<i class='bx bxs-file-find'></i>
							</div>
						</div>
						<div class="stat-footer">
							<span class="stat-trend neutral">Pendentes</span>
						</div>
					</div>
					
					<div class="stat-card">
						<div class="stat-header">
							<div class="stat-content">
								<h2 id="total-servicos" class="stat-number">-</h2>
								<p class="stat-label">Total de Serviços</p>
							</div>
							<div class="stat-icon success">
								<i class='bx bxs-wrench'></i>
							</div>
						</div>
						<div class="stat-footer">
							<span class="stat-trend neutral">Total</span>
						</div>
					</div>
					
					<div class="stat-card">
						<div class="stat-header">
							<div class="stat-content">
								<h2 id="taxa-retorno" class="stat-number">-</h2>
								<p class="stat-label">Taxa de Retorno</p>
							</div>
							<div class="stat-icon danger">
								<i class='bx bxs-error'></i>
							</div>
						</div>
						<div class="stat-footer">
							<span class="stat-trend neutral">Ajustes/Retornos</span>
						</div>
					</div>
					
					<div class="stat-card">
						<div class="stat-header">
							<div class="stat-content">
								<h2 id="motos-manutencao" class="stat-number">-</h2>
								<p class="stat-label">Motos em Manutenção</p>
							</div>
							<div class="stat-icon info">
								<i class='bx bx-car'></i>
							</div>
						</div>
						<div class="stat-footer">
							<span class="stat-trend neutral">Em andamento</span>
						</div>
					</div>
				</div>
			</div>

			<!-- Gráficos -->
			<div class="dashboard-charts">
				<div class="charts-grid">
					<div class="chart-card full-width">
						<div class="chart-header">
							<h3>Serviços Realizados por Mês</h3>
							<div class="chart-actions">
								<button class="btn-refresh" onclick="window.dashboardController?.loadCharts()">
									<i class='bx bx-refresh'></i>
								</button>
							</div>
						</div>
						<div class="chart-container">
							<div class="chart-loading" style="display: none;">
								<i class='bx bx-loader bx-spin'></i>
								<span>Carregando...</span>
							</div>
							<div class="chart" id="servicos-chart"></div>
						</div>
					</div>
					
					<div class="chart-card">
						<div class="chart-header">
							<h3>Tipos de Serviços</h3>
						</div>
						<div class="chart-container">
							<div class="chart-loading" style="display: none;">
								<i class='bx bx-loader bx-spin'></i>
								<span>Carregando...</span>
							</div>
							<div class="chart" id="tipos-servicos-chart"></div>
						</div>
					</div>
					
					<div class="chart-card">
						<div class="chart-header">
							<h3>Serviços por Marca de Moto</h3>
						</div>
						<div class="chart-container">
							<div class="chart-loading" style="display: none;">
								<i class='bx bx-loader bx-spin'></i>
								<span>Carregando...</span>
							</div>
							<div class="chart" id="servicos-moto-chart"></div>
						</div>
					</div>
					
					<div class="chart-card">
						<div class="chart-header">
							<h3>Taxa de Retorno Mensal</h3>
						</div>
						<div class="chart-container">
							<div class="chart-loading" style="display: none;">
								<i class='bx bx-loader bx-spin'></i>
								<span>Carregando...</span>
							</div>
							<div class="chart" id="taxa-retorno-chart"></div>
						</div>
					</div>
				</div>
			</div>
		</main>
	</section>
	<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
	<script type="module" src="../../assets/js/main.js"></script>
	<script>
		// Incluir DashboardController inline para garantir carregamento
		class DashboardController {
			constructor() {
				this.API_BASE_URL = 'http://localhost:3000/api';
				this.charts = {};
				this.isLoading = false;
				console.log('DashboardController: Inicializando...');
				
				// Verificar autenticação
				const token = localStorage.getItem('token');
				const userType = localStorage.getItem('userType');
				console.log('Estado da autenticação:', { 
					token: token ? 'Presente' : 'Ausente',
					userType
				});
				
				if (!token) {
					console.error('Token não encontrado, redirecionando para login...');
					window.location.href = '../../views/login/login.html';
					return;
				}
				
				this.bindEvents();
				this.handleOrientationChange();
				
				// Carregar dashboard imediatamente
				setTimeout(async () => {
					console.log('DashboardController: Carregando dashboard...');
					this.loadDashboard();
				}, 100);
			}

			bindEvents() {
				// Event listener para refresh dos dados
				const refreshBtn = document.getElementById('refresh-dashboard');
				if (refreshBtn) {
					refreshBtn.addEventListener('click', () => this.loadDashboard());
				}
			}

			async loadDashboard() {
				if (this.isLoading) return;
				
				this.isLoading = true;
				this.showLoading();

				try {
					// Carregar estatísticas gerais
					await this.loadStats();
					
					// Carregar todos os gráficos
					await this.loadCharts();
					
				} catch (error) {
					console.error('Erro ao carregar dashboard:', error);
					this.showError('Erro ao carregar dados do dashboard');
					
					// Se o erro for de autenticação, redirecionar para login
					if (error.message.includes('401')) {
						console.log('Erro de autenticação, redirecionando...');
						window.location.href = '../../views/login/login.html';
					}
				} finally {
					this.isLoading = false;
					this.hideLoading();
				}
			}

			async loadStats() {
				try {
					console.log('DashboardController: Carregando estatísticas...');
					const data = await window.apiService.getDashboardStats();
					
					if (data.success) {
						this.updateStatsCards(data.data);
					} else {
						throw new Error(data.message || 'Erro ao carregar estatísticas');
					}
				} catch (error) {
					console.error('DashboardController: Erro ao carregar estatísticas:', error);
					throw error;
				}
			}

			updateStatsCards(stats) {
				// Animar mudança de números
				const animateNumber = (element, finalValue, suffix = '') => {
					if (!element) return;
					element.classList.add('updating');
					
					setTimeout(() => {
						element.textContent = finalValue + suffix;
						element.classList.remove('updating');
					}, 300);
				};

				// Total de Serviços
				const totalServicos = document.getElementById('total-servicos');
				animateNumber(totalServicos, stats.totalServicos || '0');

				// Serviços do Mês
				const servicosMes = document.getElementById('servicos-mes');
				animateNumber(servicosMes, stats.servicosNoMes || '0');

				// Crescimento Mensal com indicador visual
				const crescimentoMensal = document.getElementById('crescimento-mensal');
				if (crescimentoMensal) {
					const crescimento = stats.crescimentoMensal || 0;
					const valor = `${crescimento >= 0 ? '+' : ''}${crescimento}%`;
					crescimentoMensal.textContent = valor;
					
					// Remover classes antigas
					crescimentoMensal.classList.remove('positive', 'negative', 'neutral');
					
					// Adicionar classe baseada no valor
					if (crescimento > 0) {
						crescimentoMensal.classList.add('positive');
					} else if (crescimento < 0) {
						crescimentoMensal.classList.add('negative');
					} else {
						crescimentoMensal.classList.add('neutral');
					}
				}

				// Taxa de Retorno
				const taxaRetorno = document.getElementById('taxa-retorno');
				animateNumber(taxaRetorno, stats.taxaRetorno || '0', '%');

				// Motos em Manutenção
				const motosManutencao = document.getElementById('motos-manutencao');
				animateNumber(motosManutencao, stats.motosEmManutencao || '0');

				// Orçamentos Pendentes
				const orcamentosPendentes = document.getElementById('orcamentos-pendentes');
				animateNumber(orcamentosPendentes, stats.orcamentosPendentes || '0');
			}

			async loadCharts() {
				try {
					console.log('DashboardController: Carregando gráficos...');
					const data = await window.apiService.getDashboardCharts();
					
					if (data.success) {
						const chartsData = data.data;
						
						// Criar gráficos
						this.createServicosChart(chartsData.servicosPorMes);
						this.createTiposServicosChart(chartsData.tiposServicos);
						this.createServicosPorMotoChart(chartsData.servicosPorMoto);
						this.createTaxaRetornoChart(chartsData.taxaRetorno);
						
						console.log('DashboardController: Gráficos criados com sucesso');
					} else {
						throw new Error(data.message || 'Erro ao carregar gráficos');
					}
				} catch (error) {
					console.error('DashboardController: Erro ao carregar gráficos:', error);
					throw error;
				}
			}

			createServicosChart(data) {
				const chartElement = document.getElementById('servicos-chart');
				if (!chartElement || !data) return;

				if (this.charts.servicosChart) {
					this.charts.servicosChart.destroy();
				}

				const isDark = document.body.classList.contains('dark');

				const options = {
					series: [{
						name: 'Serviços',
						data: data.map(item => item.total)
					}],
					chart: {
						type: 'area',
						height: 350,
						toolbar: { show: false },
						fontFamily: 'Open Sans, sans-serif',
						foreColor: isDark ? '#A0A0A0' : '#666666'
					},
					colors: ['#3b82f6'],
					dataLabels: { enabled: false },
					stroke: { curve: 'smooth', width: 3 },
					xaxis: { categories: data.map(item => item.mes) },
					yaxis: { title: { text: 'Quantidade de Serviços' } },
					fill: {
						type: 'gradient',
						gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.1, stops: [0, 100] }
					},
					tooltip: {
						theme: isDark ? 'dark' : 'light',
						y: { formatter: function(val) { return val + " serviços"; } }
					}
				};

				this.charts.servicosChart = new ApexCharts(chartElement, options);
				this.charts.servicosChart.render();
			}

			createTiposServicosChart(data) {
				const chartElement = document.getElementById('tipos-servicos-chart');
				if (!chartElement || !data) return;

				if (this.charts.tiposChart) {
					this.charts.tiposChart.destroy();
				}

				const isDark = document.body.classList.contains('dark');

				const options = {
					series: data.map(item => item.total),
					chart: { type: 'donut', height: 350 },
					labels: data.map(item => item.tipo),
					colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16'],
					legend: { position: 'bottom' },
					tooltip: {
						theme: isDark ? 'dark' : 'light',
						y: { formatter: function(val) { return val + " serviços"; } }
					}
				};

				this.charts.tiposChart = new ApexCharts(chartElement, options);
				this.charts.tiposChart.render();
			}

			createServicosPorMotoChart(data) {
				const chartElement = document.getElementById('servicos-moto-chart');
				if (!chartElement || !data) return;

				if (this.charts.motosChart) {
					this.charts.motosChart.destroy();
				}

				const isDark = document.body.classList.contains('dark');

				const options = {
					series: [{ data: data.map(item => ({ x: item.marca, y: item.total })) }],
					chart: { type: 'bar', height: 350, toolbar: { show: false } },
					colors: ['#10b981'],
					plotOptions: { bar: { horizontal: true, borderRadius: 6 } },
					dataLabels: { enabled: true },
					xaxis: { title: { text: 'Quantidade de Serviços' } },
					yaxis: { title: { text: 'Marca da Motocicleta' } },
					tooltip: {
						theme: isDark ? 'dark' : 'light',
						y: { formatter: function(val) { return val + " serviços"; } }
					}
				};

				this.charts.motosChart = new ApexCharts(chartElement, options);
				this.charts.motosChart.render();
			}

			createTaxaRetornoChart(data) {
				const chartElement = document.getElementById('taxa-retorno-chart');
				if (!chartElement || !data) return;

				if (this.charts.retornoChart) {
					this.charts.retornoChart.destroy();
				}

				const isDark = document.body.classList.contains('dark');

				const options = {
					series: [{ name: 'Taxa de Retorno', data: data.map(item => parseFloat(item.taxa_retorno)) }],
					chart: { type: 'line', height: 350, toolbar: { show: false } },
					colors: ['#ef4444'],
					stroke: { curve: 'smooth', width: 4 },
					xaxis: { categories: data.map(item => item.mes) },
					yaxis: { title: { text: 'Taxa de Retorno (%)' }, min: 0, max: 100 },
					markers: { size: 6 },
					tooltip: {
						theme: isDark ? 'dark' : 'light',
						y: { formatter: function(val) { return val.toFixed(1) + "%"; } }
					}
				};

				this.charts.retornoChart = new ApexCharts(chartElement, options);
				this.charts.retornoChart.render();
			}

			showLoading() {
				const loadingElements = document.querySelectorAll('.chart-loading');
				loadingElements.forEach(element => {
					element.style.display = 'flex';
				});
			}

			hideLoading() {
				const loadingElements = document.querySelectorAll('.chart-loading');
				loadingElements.forEach(element => {
					element.style.display = 'none';
				});
			}

			showError(message) {
				const errorContainer = document.getElementById('dashboard-error');
				if (errorContainer) {
					errorContainer.textContent = message;
					errorContainer.style.display = 'block';
					
					setTimeout(() => {
						errorContainer.style.display = 'none';
					}, 5000);
				}
			}

			handleOrientationChange() {
				window.addEventListener('orientationchange', () => {
					setTimeout(() => this.refreshChartsForTheme(), 500);
				});
			}

			refreshChartsForTheme() {
				setTimeout(() => {
					if (this.charts.servicosChart) {
						this.charts.servicosChart.destroy();
						this.loadCharts();
					}
				}, 100);
			}
		}

		// Inicializar dashboard
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', () => {
				window.dashboardController = new DashboardController();
			});
		} else {
			window.dashboardController = new DashboardController();
		}
	</script>
</body>
</html>
